
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation on token-based AuthN/Z for WLCG">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.2.11">
    
    
      
        <title>DOMA Token-based AuthZ Testbed - Token-based AuthN/Z for WLCG</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8c5ef100.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.9647289d.min.css">
        
          
          
          <meta name="theme-color" content="#4051b5">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#doma-token-based-authz-testbed" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Token-based AuthN/Z for WLCG" class="md-header__button md-logo" aria-label="Token-based AuthN/Z for WLCG" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Token-based AuthN/Z for WLCG
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              DOMA Token-based AuthZ Testbed
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Token-based AuthN/Z for WLCG" class="md-nav__button md-logo" aria-label="Token-based AuthN/Z for WLCG" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Token-based AuthN/Z for WLCG
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        The WLCG Virtual Organization
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Token based authorization
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Token based authorization" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Token based authorization
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Token-based authorization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../compliance/" class="md-nav__link">
        WLCG JWT compliance
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          DOMA Token-based AuthZ Testbed
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        DOMA Token-based AuthZ Testbed
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#joining-testbed" class="md-nav__link">
    Joining testbed
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iam" class="md-nav__link">
    IAM
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ce" class="md-nav__link">
    CE
  </a>
  
    <nav class="md-nav" aria-label="CE">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#arc-ce" class="md-nav__link">
    ARC-CE
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configured-endpoints" class="md-nav__link">
    Configured endpoints
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#htcondor-ce" class="md-nav__link">
    HTCondor-CE
  </a>
  
    <nav class="md-nav" aria-label="HTCondor-CE">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#obtain-access-token-with-compute-scopes" class="md-nav__link">
    Obtain access token with compute.* scopes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configured-endpoints_1" class="md-nav__link">
    Configured endpoints
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#storage" class="md-nav__link">
    Storage
  </a>
  
    <nav class="md-nav" aria-label="Storage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implementations" class="md-nav__link">
    Implementations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configured-endpoints_2" class="md-nav__link">
    Configured endpoints:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fts" class="md-nav__link">
    FTS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rucio" class="md-nav__link">
    RUCIO
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring" class="md-nav__link">
    Monitoring
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../issues/" class="md-nav__link">
        Known issues
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../oidc-agent/" class="md-nav__link">
        OIDC Agent
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_6" type="checkbox" id="__nav_2_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_6">
          Configuration
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Configuration" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_6">
          <span class="md-nav__icon md-icon"></span>
          Configuration
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../configuration/dcache/" class="md-nav__link">
        dCache
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../configuration/dpm/" class="md-nav__link">
        DPM
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../configuration/storm/" class="md-nav__link">
        StoRM
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../configuration/xrootd/" class="md-nav__link">
        XRootD
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#joining-testbed" class="md-nav__link">
    Joining testbed
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iam" class="md-nav__link">
    IAM
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ce" class="md-nav__link">
    CE
  </a>
  
    <nav class="md-nav" aria-label="CE">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#arc-ce" class="md-nav__link">
    ARC-CE
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configured-endpoints" class="md-nav__link">
    Configured endpoints
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#htcondor-ce" class="md-nav__link">
    HTCondor-CE
  </a>
  
    <nav class="md-nav" aria-label="HTCondor-CE">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#obtain-access-token-with-compute-scopes" class="md-nav__link">
    Obtain access token with compute.* scopes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configured-endpoints_1" class="md-nav__link">
    Configured endpoints
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#storage" class="md-nav__link">
    Storage
  </a>
  
    <nav class="md-nav" aria-label="Storage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implementations" class="md-nav__link">
    Implementations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configured-endpoints_2" class="md-nav__link">
    Configured endpoints:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fts" class="md-nav__link">
    FTS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rucio" class="md-nav__link">
    RUCIO
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring" class="md-nav__link">
    Monitoring
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="doma-token-based-authz-testbed">DOMA Token-based AuthZ Testbed</h1>
<h2 id="joining-testbed">Joining testbed</h2>
<p>Send mail to <a href="https://e-groups.cern.ch/e-groups/Egroup.do?egroupId=10301575">wlcg-doma-tpc e-group</a> if you want to join <a href="https://atlas-kibana.mwt2.org:5601/s/rucio/goto/07442ef87b3ba72bc391edde8770de4b">Rucio DOMA Functional Tests OIDC</a> or advertise your CE that support job submission with tokens. Please include necessary to access your SE/CE endpoint, as an example you can use entries that were already filled in tables with available resources that to some degree already supports tokens.</p>
<h2 id="iam">IAM</h2>
<p>To be able to use tokens it is necessary to know which token issuer is used by individual VOs. For tests we use WLCG IAM token issuer which provides services for "wlcg" VO, e.g.</p>
<table>
<thead>
<tr>
<th>VO</th>
<th>Issuer</th>
</tr>
</thead>
<tbody>
<tr>
<td>WLCG IAM</td>
<td>https://wlcg.cloud.cnaf.infn.it/</td>
</tr>
<tr>
<td>ATLAS IAM</td>
<td>https://atlas-auth.web.cern.ch/</td>
</tr>
<tr>
<td>CMS IAM</td>
<td>https://cms-auth.web.cern.ch/</td>
</tr>
<tr>
<td>DUNE</td>
<td>https://cilogon.org/dune</td>
</tr>
<tr>
<td>Fermilab</td>
<td>https://cilogon.org/fermilab</td>
</tr>
</tbody>
</table>
<p>OSG have token isser details stored with all VO detail in their <a href="https://github.com/opensciencegrid/topology/tree/master/virtual-organizations">virtual-organization topology</a> files. WLCG/EGI currently doesn't provide common (trusted) place with token isser details, but naturally this could become part of <a href="https://operations-portal.egi.eu/vo/view/voname/atlas">EGI VO ID Cards</a> (briefly touched this topic <a href="https://indico.cern.ch/event/1177943/?note=203576">here</a>).</p>
<h2 id="ce">CE</h2>
<h3 id="arc-ce"><a href="https://www.nordugrid.org/arc/arc6/misc/oidc_tokens.html">ARC-CE</a></h3>
<p>ARC-CE 6.12 still has limited support for WLCG JWT tokens and they can be only used
to submit jobs with HTTP based protocols (<code>EMI-ES</code> and <code>REST</code> interface). With current
limitations configuration close to expectations from WLCG JWT profile could look like
(replace <code>arc1.farm.particle.cz</code> with your ARC-CE hostname):</p>
<pre><code># ...
[authtokens]

[authgroup: wlcg_iam]
authtokens = * https://wlcg.cloud.cnaf.infn.it/ https://arc1.farm.particle.cz compute.create /wlcg/pilots
authtokens = * https://wlcg.cloud.cnaf.infn.it/ https://arc1.farm.particle.cz compute.read /wlcg/pilots
authtokens = * https://wlcg.cloud.cnaf.infn.it/ https://arc1.farm.particle.cz compute.modify /wlcg/pilots
authtokens = * https://wlcg.cloud.cnaf.infn.it/ https://arc1.farm.particle.cz compute.cancel /wlcg/pilots

# accept token issued by EGI Check-in for job submission (both old MitreID and new Keycloak issuer)
[authgroup: egi_aai]
# very rough / DANGEROUS configuration - accepting all tokens without restrictions
#authtokens = * https://aai.egi.eu/oidc/ * * *
#authtokens = * https://aai.egi.eu/auth/realms/egi * * *
# it is possible to restrict job submission to the specific EGI user
authtokens = 85ff127e07ea6660c727831b99e18e4e96b319283f8d2cc8113f405bad2ba261@egi.eu https://aai.egi.eu/oidc/ * * *
authtokens = 85ff127e07ea6660c727831b99e18e4e96b319283f8d2cc8113f405bad2ba261@egi.eu https://aai.egi.eu/auth/realms/egi * * *

# just an example for ARC-CE running on arc1.farm.particle.cz
# recommendation for ATLAS configuration may change in fugure
# (this is not the official ATLAS site configuration documentation)
[authgroup: atlas_iam_prd]
authtokens = 7dee38a3-6ab8-4fe2-9e4c-58039c21d817 https://atlas-auth.web.cern.ch/ https://arc1.farm.particle.cz compute.create *
authtokens = 7dee38a3-6ab8-4fe2-9e4c-58039c21d817 https://atlas-auth.web.cern.ch/ https://arc1.farm.particle.cz compute.read *
authtokens = 7dee38a3-6ab8-4fe2-9e4c-58039c21d817 https://atlas-auth.web.cern.ch/ https://arc1.farm.particle.cz compute.modify *
authtokens = 7dee38a3-6ab8-4fe2-9e4c-58039c21d817 https://atlas-auth.web.cern.ch/ https://arc1.farm.particle.cz compute.cancel *
[authgroup: atlas_iam_plt]
authtokens = 750e9609-485a-4ed4-bf16-d5cc46c71024 https://atlas-auth.web.cern.ch/ https://arc1.farm.particle.cz compute.create *
authtokens = 750e9609-485a-4ed4-bf16-d5cc46c71024 https://atlas-auth.web.cern.ch/ https://arc1.farm.particle.cz compute.read *
authtokens = 750e9609-485a-4ed4-bf16-d5cc46c71024 https://atlas-auth.web.cern.ch/ https://arc1.farm.particle.cz compute.modify *
authtokens = 750e9609-485a-4ed4-bf16-d5cc46c71024 https://atlas-auth.web.cern.ch/ https://arc1.farm.particle.cz compute.cancel *
[authgroup: atlas_iam_sgm]
authtokens = 5c5d2a4d-9177-3efa-912f-1b4e5c9fb660 https://atlas-auth.web.cern.ch/ https://arc1.farm.particle.cz compute.create *
authtokens = 5c5d2a4d-9177-3efa-912f-1b4e5c9fb660 https://atlas-auth.web.cern.ch/ https://arc1.farm.particle.cz compute.read *
authtokens = 5c5d2a4d-9177-3efa-912f-1b4e5c9fb660 https://atlas-auth.web.cern.ch/ https://arc1.farm.particle.cz compute.modify *
authtokens = 5c5d2a4d-9177-3efa-912f-1b4e5c9fb660 https://atlas-auth.web.cern.ch/ https://arc1.farm.particle.cz compute.cancel *

# again, just an example for ARC-CE running on arc1.farm.particle.cz
# (this is not the official CMS site configuration documentation)
[authgroup: cms_iam_pilot]
authtokens = bad55f4e-602c-4e8d-a5c5-bd8ffb762113 https://cms-auth.web.cern.ch/ https://arc1.farm.particle.cz compute.create *
authtokens = bad55f4e-602c-4e8d-a5c5-bd8ffb762113 https://cms-auth.web.cern.ch/ https://arc1.farm.particle.cz compute.read *
authtokens = bad55f4e-602c-4e8d-a5c5-bd8ffb762113 https://cms-auth.web.cern.ch/ https://arc1.farm.particle.cz compute.modify *
authtokens = bad55f4e-602c-4e8d-a5c5-bd8ffb762113 https://cms-auth.web.cern.ch/ https://arc1.farm.particle.cz compute.cancel *
[authgroup: cms_iam_test]
authtokens = 08ca855e-d715-410e-a6ff-ad77306e1763 https://cms-auth.web.cern.ch/ https://arc1.farm.particle.cz compute.create *
authtokens = 08ca855e-d715-410e-a6ff-ad77306e1763 https://cms-auth.web.cern.ch/ https://arc1.farm.particle.cz compute.read *
authtokens = 08ca855e-d715-410e-a6ff-ad77306e1763 https://cms-auth.web.cern.ch/ https://arc1.farm.particle.cz compute.modify *
authtokens = 08ca855e-d715-410e-a6ff-ad77306e1763 https://cms-auth.web.cern.ch/ https://arc1.farm.particle.cz compute.cancel *
[authgroup: cms_iam_itb]
authtokens = 490a9a36-0268-4070-8813-65af031be5a3 https://cms-auth.web.cern.ch/ https://arc1.farm.particle.cz compute.create *
authtokens = 490a9a36-0268-4070-8813-65af031be5a3 https://cms-auth.web.cern.ch/ https://arc1.farm.particle.cz compute.read *
authtokens = 490a9a36-0268-4070-8813-65af031be5a3 https://cms-auth.web.cern.ch/ https://arc1.farm.particle.cz compute.modify *
authtokens = 490a9a36-0268-4070-8813-65af031be5a3 https://cms-auth.web.cern.ch/ https://arc1.farm.particle.cz compute.cancel *

# this assumes existence of local users wlcg, egi, atlasprd, atlasplt, atlassgm, cmsplt, cmstest and cmsitb with corresponding groups
[mapping]
map_to_user = wlcg_iam wlcg:wlcg
map_to_user = egi_aai egi:egi
map_to_user = atlas_iam_prd atlasprd:atlasprd
map_to_user = atlas_iam_plt atlasplt:atlasplt
map_to_user = atlas_iam_sgm atlassgm:atlassgm
map_to_user = cms_iam_pilot cmsplt:cmsplt
map_to_user = cms_iam_test cmstest:cmstest
map_to_user = cms_iam_itb cmsitb:cmsitb
policy_on_nomap=stop

[arex/ws/jobs]
allowaccess=wlcg_iam
allowaccess=egi_aai
allowaccess=atlas_iam_prd
allowaccess=atlas_iam_plt
allowaccess=atlas_iam_sgm
allowaccess=cms_iam_pilot
allowaccess=cms_iam_test
allowaccess=cms_iam_itb
# ...
</code></pre>
<p>Token implementation in ARC-CE is still preliminary and it seems possible there
will be changes even in the structure of configuration file. You should <a href="https://www.nordugrid.org/arc/arc6/misc/oidc_tokens.html">follow
official documentation</a>
if you install more recent ARC-CE version.</p>
<p>Even though job submission is possible with tokens it is still necessary to have
existing X.509 proxy, because current <code>arcsub</code> version still unconditionally verify
proxy presence. On the other hand this proxy is delegated to ARC-CE regardless
of auth mechanism used to submit jobs.</p>
<p>With token in <code>BEARER_TOKEN</code> environement variable (<code>ARC_OTOKEN</code> for older ARC-CE 6.7
clients) token'll be automatically used for authorization with HTTP interface, e.g.</p>
<pre><code>cat &gt; test.xrsl &lt;&lt;EOF
&amp;(executable=&quot;/usr/bin/env&quot;)
(stdout=&quot;test.out&quot;)
(stderr=&quot;test.err&quot;)
(jobname=&quot;ARC-CE test&quot;)
(runtimeenvironment = &quot;ENV/PROXY&quot;)
EOF
# following line is necessary for ARC-CE 6.7 client
# newer version use BEARER_TOKEN or token discovery
#export ARC_OTOKEN=$(oidc-token --aud=https://arc1.farm.particle.cz --scope=compute.read --scope=compute.modify --scope=compute.cancel --scope=compute.create --scope=wlcg.groups:/wlcg/pilots OIDC_STORE_NAME)
export BEARER_OTOKEN=$(oidc-token --aud=https://arc1.farm.particle.cz --scope=compute.read --scope=compute.modify --scope=compute.cancel --scope=compute.create --scope=wlcg.groups:/wlcg/pilots OIDC_STORE_NAME)
arcsub --debug=DEBUG --info-endpoint-type arcrest --submission-endpoint-type arcrest --computing-element arc1.farm.particle.cz test.xrsl
</code></pre>
<p>ARC-CE support token discovery as described in <a href="https://zenodo.org/record/3937438">WLCG Bearer Token Discovery</a></p>
<h3 id="configured-endpoints">Configured endpoints</h3>
<table>
<thead>
<tr>
<th>Site</th>
<th>Host</th>
<th>VO</th>
<th>Audience</th>
<th>Group</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://goc.egi.eu/portal/index.php?Page_Type=Site&amp;id=288">praguelcg2</a></td>
<td>arc1.farm.particle.cz, arc2.farm.particle.cz</td>
<td>wlcg</td>
<td>*</td>
<td>/wlcg/pilots</td>
</tr>
<tr>
<td><a href="https://goc.egi.eu/portal/index.php?Page_Type=Site&amp;id=288">praguelcg2</a></td>
<td>arc1.farm.particle.cz, arc2.farm.particle.cz</td>
<td>atlas, dune</td>
<td>*</td>
<td>*</td>
</tr>
</tbody>
</table>
<h3 id="htcondor-ce"><a href="https://htcondor.github.io/htcondor-ce/v5/installation/htcondor-ce/">HTCondor-CE</a></h3>
<p>It is possible to submit jobs with WLCG JWT token if HTCondor accepts <code>SCITOKENS</code>.
By default HTCondor-CE is configured with <a href="https://github.com/WLCG-AuthZ-WG/common-jwt-profile/blob/master/profile.md#common-claims">non-standard <code>aud</code> claim</a>, but this can
be changed by adding following line in <code>/etc/condor-ce/config.d/99-local</code> file</p>
<pre><code>SCITOKENS_SERVER_AUDIENCE = $(SCITOKENS_SERVER_AUDIENCE) condor://$(COLLECTOR_HOST)
# special &quot;any&quot; audience, not recommended for production use
#SCITOKENS_SERVER_AUDIENCE = $(SCITOKENS_SERVER_AUDIENCE) https://wlcg.cern.ch/jwt/v1/any
</code></pre>
<p>All other configuration and identity mapping is described in the
<a href="https://htcondor.github.io/htcondor-ce/v5/configuration/authentication/">documentation</a>.
Currently identity mapping is limited to <code>sub</code>+<code>iss</code> which is not sufficient for IAM shared
by multiple groups (e.g. Fermialab), but there are plans to implement callout similar
to the GSI lcmaps.</p>
<p>Follow these steps to submit job with token to HTCondor-CE</p>
<pre><code>cat &gt; test.sub &lt;&lt;EOF
executable = /bin/env
output = env.out
error = env.err
log = env.log
queue
EOF

# get access token, e.g. from oidc-agent (see bellow) and store its
# content in a file used by WLCG bearer token discovery mechanism
oidc-token --aud=condor://osgce3.farm.particle.cz:9619 -s compute.create -s compute.read -s compute.modify -s compute.cancel wlcg-compute &gt; $XDG_RUNTIME_DIR/bt_u$(id -u)

export CONDOR_CONFIG=/dev/null
export GSI_AUTHZ_CONF=/dev/null
export _condor_AUTH_SSL_CLIENT_CADIR=/etc/grid-security/certificates
export _condor_SEC_CLIENT_AUTHENTICATION_METHODS=SCITOKENS

condor_ping -verbose -pool osgce3.farm.particle.cz:9619 -name osgce3.farm.particle.cz WRITE
condor_submit -pool osgce3.farm.particle.cz:9619 -remote osgce3.farm.particle.cz test.sub
condor_q -pool osgce3.farm.particle.cz:9619 -name osgce3.farm.particle.cz
</code></pre>
<h4 id="obtain-access-token-with-compute-scopes">Obtain access token with compute.* scopes</h4>
<ul>
<li>oidc-agent</li>
</ul>
<pre><code># start oidc-agent (if it is not already running)
eval $(oidc-gen)
# register new client in oidc-agent with compute.* scopes (one time
# action, but not all IAM allows user to apply for compute.* scopes)
oidc-gen --iss=https://wlcg.cloud.cnaf.infn.it/ --scope=&quot;openid offline_access wlcg.groups compute.create compute.read compute.modify compute.cancel&quot; wlcg-compute
# obtain token with all necessary scopes and right audience
oidc-token --aud=condor://osgce3.farm.particle.cz:9619 --scope &quot;compute.create compute.read compute.modify compute.cancel&quot; wlcg-compute &gt; $XDG_RUNTIME_DIR/bt_u$(id -u)
</code></pre>
<ul>
<li>client credentials grant (client registered in IAM with <code>compute.*</code> scopes, grant type "client credentials" and response type "token")</li>
</ul>
<pre><code>curl -s --data &quot;grant_type=client_credentials&amp;client_id=client_id_from_iam_registration&amp;client_secret=client_secret_from_iam_registration&amp;audience=condor://osgce3.farm.particle.cz:9619&quot; https://wlcg.cloud.cnaf.infn.it/token | jq -r .access_token &gt; $XDG_RUNTIME_DIR/bt_u$(id -u)
</code></pre>
<h3 id="configured-endpoints_1">Configured endpoints</h3>
<p>All <a href="http://novastore.farm.particle.cz/ce/condor-ce/#osg_htcondor-ce_sites">OSG sites</a> should now support job submission with token. You can <a href="http://novastore.farm.particle.cz/cgi-bin/condor.cgi">test your HTCondor-CE</a> configuration with ATLAS jobs submission.</p>
<table>
<thead>
<tr>
<th>Site</th>
<th>Host</th>
<th>VO</th>
<th>Audience</th>
</tr>
</thead>
<tbody>
<tr>
<td>osg</td>
<td>hosted-ce-chtc-ubuntu.osg.chtc.io:9619</td>
<td>wlcg</td>
<td>hosted-ce-chtc-ubuntu.osg.chtc.io:9619</td>
</tr>
<tr>
<td><a href="https://goc.egi.eu/portal/index.php?Page_Type=Site&amp;id=288">praguelcg2</a></td>
<td>osgce1.farm.particle.cz:9619</td>
<td>wlcg, atlas, dune</td>
<td>osgce1.farm.particle.cz:9619, condor://osgce1.farm.particle.cz:9619, https://wlcg.cern.ch/jwt/v1/any</td>
</tr>
</tbody>
</table>
<h2 id="storage">Storage</h2>
<h3 id="implementations">Implementations</h3>
<ul>
<li><a href="https://www.dcache.org/manuals/Book-6.2/config-gplazma.shtml#using-openid-connect">dCache</a> (<a href="https://www.dcache.org/manuals/UserGuide-6.2/webdav.shtml#authorising-the-data-transfer">transfer documentation</a>)</li>
<li><a href="https://twiki.cern.ch/twiki/bin/view/DPM/DpmSetupPuppetInstallation#OpenID_Connect_and_WLCG_bearer_t">DPM</a></li>
<li>Echo (CEPH + XRootD plugin)</li>
<li>EOS</li>
<li>StoRM (<a href="../configuration/storm/">configuration instructions</a>)</li>
<li>XRootD</li>
</ul>
<h3 id="configured-endpoints_2">Configured endpoints:</h3>
<table>
<thead>
<tr>
<th>Site</th>
<th>Implementation</th>
<th>Host</th>
<th>VO</th>
<th>Audience</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://goc.egi.eu/portal/index.php?Page_Type=Site&amp;id=288">praguelcg2</a></td>
<td>DPM 1.15.0</td>
<td>https://golias100.farm.partile.cz/dpm/farm.particle.cz/home/wlcg</td>
<td>wlcg</td>
<td>https://wlcg.cern.ch/jwt/v1/any</td>
</tr>
<tr>
<td>UNL</td>
<td>XRootD</td>
<td>https://red-gridftp12.unl.edu:1094/user/dteam</td>
<td>wlcg</td>
<td></td>
</tr>
<tr>
<td>DESY Devel</td>
<td>dCache 7.1</td>
<td>https://prometheus.desy.de:2443/VOs/wlcg</td>
<td>wlcg</td>
<td></td>
</tr>
<tr>
<td>CNAF Prod</td>
<td>StoRM</td>
<td>https://xfer.cr.cnaf.infn.it:8443/wlcg</td>
<td>wlcg</td>
<td></td>
</tr>
<tr>
<td>CNAF Devel</td>
<td>StoRM</td>
<td>https://amnesiac.cloud.cnaf.infn.it:8443/wlcg</td>
<td>wlcg</td>
<td></td>
</tr>
<tr>
<td>CERN ATLAS</td>
<td>EOS</td>
<td>https://eosatlas.cern.ch:443/eos/atlas/atlasscratchdisk/3rdpartycopy</td>
<td>atlas</td>
<td></td>
</tr>
<tr>
<td>CERN Devel</td>
<td>EOS</td>
<td>https://eospps.cern.ch:443/eos/opstest/tpc/https</td>
<td>wlcg</td>
<td></td>
</tr>
<tr>
<td>RAL</td>
<td>Echo</td>
<td>https://ceph-gw8.gridpp.rl.ac.uk:1094/dteam:test/</td>
<td>wlcg</td>
<td></td>
</tr>
<tr>
<td>Manchester Test</td>
<td>DPM</td>
<td>https://vm33.in.tier2.hep.manchester.ac.uk:443/dpm/tier2.hep.manchester.ac.uk/home/wlcg</td>
<td>wlcg</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="fts"><a href="http://fts3-docs.web.cern.ch/fts3-docs/docs/install/fts3.html">FTS</a></h2>
<p><a href="https://fts3-devel.cern.ch:8449">CERN Devel FTS</a> with 3.10.x provides JWT support for WLCG and XDC.</p>
<pre><code>fts-rest-whoami --access-token=&lt;token&gt; -s https://fts3-devel.cern.ch:8446
fts-rest-transfer-submit --access-token=&lt;token&gt; -s https://fts3-devel.cern.ch:8446 &lt;src_url&gt; &lt;dst_url&gt;
fts-rest-transfer-status --access-token=&lt;token&gt; -s https://fts3-devel.cern.ch:8446
</code></pre>
<p>Be aware that for sucessfull FTS transfer submission with OIDC you also need recent 3.10.x FTS rest client.</p>
<h2 id="rucio">RUCIO</h2>
<p>Install Rucio client with one method described in <a href="https://rucio.readthedocs.io/en/latest/installing_clients.html">documentation</a>, e.g.</p>
<pre><code class="language-shell"># latest rucio client works only with python3
virtualenv-3 rucio
source rucio/bin/activate
pip3 install rucio-clients
pip3 install gfal2-python
</code></pre>
<p>and save following configuration file in <code>rucio/etc/rucio.cfg</code> for WLCG DOMA Rucio OIDC tests</p>
<pre><code class="language-shell">[client]
rucio_host = https://rucio-doma.cern.ch:443
auth_host = https://rucio-doma-auth.cern.ch:443
auth_type = oidc
account = wlcg_doma
oidc_issuer = wlcg
ca_cert = /etc/grid-security/certificates
#ca_cert = /etc/pki/tls/certs/CERN-bundle.pem
</code></pre>
<p>Setup environment for Rucio client installed in virtualenv</p>
<pre><code class="language-shell">source rucio/bin/activate
</code></pre>
<p>or if you use different installation method just set <code>RUCIO_HOME</code> environment
variable to the base directory with <code>etc/rucio.cfg</code> file</p>
<pre><code class="language-shell">export RUCIO_HOME=/base/path/to/rucio
</code></pre>
<p><a href="https://wlcg.cloud.cnaf.infn.it">WLCG IAM account</a> is necessary to
access <a href="https://rucio-doma-webui.cern.ch">WLCG DOMA Rucio instance</a>
and user sub claim (WLCG IAM uuid identity) must be associated with
<code>wlcg_doma</code> Rucio account by DOMA Rucio ADMIN. It is also possible to
associate user certificate subject with <code>wlcg_doma</code> Rucio account to
provide access with WLCG VO X.509 certificate proxy, but for different
authorization type it is necessary to update <code>auth_type = x509_proxy</code>
in <code>rucio.cfg</code> or setting environment variable
<code>RUCIO_AUTH_TYPE=x509_proxy</code>.</p>
<h2 id="monitoring">Monitoring</h2>
<ul>
<li><a href="https://atlas-kibana.mwt2.org:5601/s/rucio/app/kibana#/dashboard/58b37580-b601-11ea-a57f-cfdaa2417d86">Functional Tests with WLCG OIDC</a></li>
<li><a href="https://gitlab.cern.ch/wlcg-doma-rucio/flux/-/tree/master/releases/integration">Rucio DOMA Configuration</a></li>
<li><a href="https://atlas-kibana.mwt2.org:5601/s/rucio/goto/2cdbb5f83cbe74358ed4287a764426dd">Rucio DOMA Logs</a></li>
<li><a href="https://fts3-devel.cern.ch:8449/fts3/ftsmon/#/">CERN FTS3 Devel</a></li>
<li><a href="https://monit-grafana.cern.ch/d/000000670/fts-servers-dashboard?orgId=25&amp;var-group_by=activity&amp;var-vo=dteam&amp;var-vo_es=dteam&amp;var-source_se=All&amp;var-source_se_es=All&amp;var-src_country=All&amp;var-dst_country=All&amp;var-src_site=All&amp;var-dst_site=All&amp;var-dest_se=All&amp;var-dest_se_es=All&amp;var-fts_server=fts3-devel.cern.ch&amp;var-fts_server_es=fts3-devel.cern.ch&amp;var-bin=1h&amp;var-dest_hostname=All&amp;var-source_hostname=All">FTS Grafana</a></li>
</ul>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../compliance/" class="md-footer__link md-footer__link--prev" aria-label="Previous: WLCG JWT compliance" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              WLCG JWT compliance
            </div>
          </div>
        </a>
      
      
        
        <a href="../issues/" class="md-footer__link md-footer__link--next" aria-label="Next: Known issues" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Known issues
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.748e2769.min.js"></script>
      
    
  </body>
</html>