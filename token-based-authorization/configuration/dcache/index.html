
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation on token-based AuthN/Z for WLCG">
      
      
      
      
        <link rel="prev" href="../../oidc-agent/">
      
      
        <link rel="next" href="../dpm/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.5">
    
    
      
        <title>dCache - Token-based AuthN/Z for WLCG</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.6a10b989.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.356b1318.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#dcache" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Token-based AuthN/Z for WLCG" class="md-header__button md-logo" aria-label="Token-based AuthN/Z for WLCG" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Token-based AuthN/Z for WLCG
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              dCache
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Token-based AuthN/Z for WLCG" class="md-nav__button md-logo" aria-label="Token-based AuthN/Z for WLCG" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Token-based AuthN/Z for WLCG
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    The WLCG Virtual Organization
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Token based authorization
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Token based authorization
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Token-based authorization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../compliance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    WLCG JWT compliance
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../doma-testbed/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DOMA Token-based AuthZ Testbed
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../issues/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Known issues
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../oidc-agent/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OIDC Agent
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6" checked>
        
          
          <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Configuration
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            Configuration
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    dCache
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    dCache
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#wlcg-jwt-compliance-testbed" class="md-nav__link">
    WLCG JWT compliance testbed
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dcache-plugins-for-wlcgscitoken-profile" class="md-nav__link">
    dCache plugins for WLCG/SciToken profile
  </a>
  
    <nav class="md-nav" aria-label="dCache plugins for WLCG/SciToken profile">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dcache-72-configuration" class="md-nav__link">
    dCache 7.2 configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dcache-82-configuration" class="md-nav__link">
    dCache 8.2 configuration
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supporting-x509-and-token-access-at-same-time" class="md-nav__link">
    Supporting X.509 and token access at same time
  </a>
  
    <nav class="md-nav" aria-label="Supporting X.509 and token access at same time">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dcache-ownership-inheritance" class="md-nav__link">
    dCache ownership inheritance
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#acl-configuration" class="md-nav__link">
    ACL configuration
  </a>
  
    <nav class="md-nav" aria-label="ACL configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#recursive-acl-updates" class="md-nav__link">
    Recursive ACL updates
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supported-authorizations" class="md-nav__link">
    Supported authorizations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#storage-mapping-and-permissions-configuration" class="md-nav__link">
    Storage mapping and permissions configuration
  </a>
  
    <nav class="md-nav" aria-label="Storage mapping and permissions configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#wlcg-compliance-testbed" class="md-nav__link">
    WLCG compliance testbed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#atlas" class="md-nav__link">
    ATLAS
  </a>
  
    <nav class="md-nav" aria-label="ATLAS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    configuration
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../dpm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DPM
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../requirements/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Requirements
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../storm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    StoRM
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../xrootd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    XRootD
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#wlcg-jwt-compliance-testbed" class="md-nav__link">
    WLCG JWT compliance testbed
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dcache-plugins-for-wlcgscitoken-profile" class="md-nav__link">
    dCache plugins for WLCG/SciToken profile
  </a>
  
    <nav class="md-nav" aria-label="dCache plugins for WLCG/SciToken profile">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dcache-72-configuration" class="md-nav__link">
    dCache 7.2 configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dcache-82-configuration" class="md-nav__link">
    dCache 8.2 configuration
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supporting-x509-and-token-access-at-same-time" class="md-nav__link">
    Supporting X.509 and token access at same time
  </a>
  
    <nav class="md-nav" aria-label="Supporting X.509 and token access at same time">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dcache-ownership-inheritance" class="md-nav__link">
    dCache ownership inheritance
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#acl-configuration" class="md-nav__link">
    ACL configuration
  </a>
  
    <nav class="md-nav" aria-label="ACL configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#recursive-acl-updates" class="md-nav__link">
    Recursive ACL updates
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supported-authorizations" class="md-nav__link">
    Supported authorizations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#storage-mapping-and-permissions-configuration" class="md-nav__link">
    Storage mapping and permissions configuration
  </a>
  
    <nav class="md-nav" aria-label="Storage mapping and permissions configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#wlcg-compliance-testbed" class="md-nav__link">
    WLCG compliance testbed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#atlas" class="md-nav__link">
    ATLAS
  </a>
  
    <nav class="md-nav" aria-label="ATLAS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    configuration
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="dcache">dCache</h1>
<p><a href="https://www.dcache.org/manuals/Book-9.2/config-gplazma.shtml#oidc">OIDC plugin reference</a> describes parameters and configuration options that can be used to deal with clients authorized with tokens. dCache supports several token profiles including WLCG/SciToken profiles. dCache provides two different gPlazma plugins to deal with OIDC tokens that follow WLCG profile - <code>oidc</code> and <code>scitoken</code>. With dCache 7.x it is necessary to use <code>scitoken</code> plugin, because this is the only way to deal with WLCG JWT tokens or SciTokens. The dCache 8.x comes with more generic <code>oidc</code> plugin that can process also WLCG JWT tokens and SciTokens (<code>scitoken</code> plugin is still kept for compatibility reasons, but it is deprecated).</p>
<h2 id="wlcg-jwt-compliance-testbed">WLCG JWT compliance testbed</h2>
<p>There are several dCache instances already included in the <a href="https://github.com/indigo-iam/wlcg-jwt-compliance-tests#storage-area-configuration-pre-requisites">testbed</a> including <a href="https://confluence.desy.de/pages/viewpage.action?pageId=228761933"><code>prometheus.desy.de</code></a>, which is maitained by dCache developers and it is running <code>master</code> branch.</p>
<h2 id="dcache-plugins-for-wlcgscitoken-profile">dCache plugins for WLCG/SciToken profile</h2>
<h3 id="dcache-72-configuration">dCache 7.2 configuration</h3>
<p>To accept connection authorized with WLCG JWT tokens it is necessary to add <code>scitoken</code> plugin in the chain of gPlazma auth plugins. Just add following line in your <code>/etc/dcache/gplazma.conf</code> configuration</p>
<pre><code>auth     optional     scitoken
map      sufficient   multimap gplazma.multimap.file=/etc/dcache/multi-mapfile.wlcg_jwt
</code></pre>
<p>This line alone is not sufficient for gPlazma service configuration, because it is necessary to specify supported WLCG JWT issuers. This can be done in the corresponding layout file with defined gPlazma service e.g.</p>
<pre><code># ...
[centralDomain/gplazma]
# assuming that VO starts in top level directory
gplazma.scitoken.issuer!wlcg = https://wlcg.cloud.cnaf.infn.it/ /wlcg
gplazma.scitoken.issuer!altas = https://atlas-auth.web.cern.ch/ /atlas
gplazma.scitoken.issuer!cms = https://cms-auth.web.cern.ch/ /cms
# assuming that dCache WebDAV service runs on default HTTPS port 443 for doors dcache.example.com
#gplazma.scitoken.audience-targets = https://dcache.example.com
# you can specify multiple audiences (https://wlcg.cern.ch/jwt/v1/any is necessary for compliance testbed)
gplazma.scitoken.audience-targets = https://wlcg.cern.ch/jwt/v1/any https://dcache.example.com https://dcache.example.com:2880 https://alias.example.com roots://dcache.example.com 
# ...
</code></pre>
<p>It is necessary to map identity extracted from WLCG JWT token (in this case we rely on multimap "<code>op</code>" that gives us access to the token issuer mapped to our name configured in the layout file) to the dCache <code>uid</code>, <code>gid</code> and <code>username</code>, e.g. by using multimap file <code>/etc/dcache/multi-mapfile.wlcg_jwt</code></p>
<pre><code>op:wlcg               uid:1999 gid:1999,true username:wlcg_oidc
op:atlas              uid:2999 gid:2999,true username:atlas_oidc
op:cms                uid:3999 gid:3999,true username:cms_oidc
</code></pre>
<p>Be wery careful how you map WLCG JWT token indentity and when you support also X.509 voms proxies. Most probably it'll be necessary to very carefully add additional ACLs to your VO (sub)directories or rely on dCache ownership inheritance from the parent directory.</p>
<h3 id="dcache-82-configuration">dCache 8.2 configuration</h3>
<p>This version comes with</p>
<ol>
<li>WLCG JWT profile support integrated in "oidc" gPlazma plugin</li>
<li>Support for access with tokens with roots:// protocol on same port 1094</li>
<li>Starting with 8.2.7 preferred authorization plugin is set to ZTN and we can simply rely on BEARER_TOKEN variable</li>
<li>Symlinks properly handled since 8.2.22</li>
</ol>
<p>Following configuration updates should add support for token access</p>
<pre><code># /etc/dcache/gplazma.conf
...
auth     optional     oidc
map      sufficient   multimap gplazma.multimap.file=/etc/dcache/multi-mapfile.oidc
...
</code></pre>
<pre><code># /etc/dcache/layouts/your_layout_file.conf
# ...
[centralDomain/gplazma]
# assuming that VO starts in top level directory
gplazma.oidc.provider!wlcg = https://wlcg.cloud.cnaf.infn.it/ -profile=wlcg -prefix=/wlcg
gplazma.oidc.provider!altas = https://atlas-auth.web.cern.ch/ -profile=wlcg -prefix=/atlas
gplazma.oidc.provider!cms = https://cms-auth.web.cern.ch/ -profile=wlcg -prefix=/cms
# assuming that dCache WebDAV service runs on default HTTPS port 443 for doors dcache.example.com
#gplazma.oidc.audience-targets = https://dcache.example.com
# you can specify multiple audiences (https://wlcg.cern.ch/jwt/v1/any is necessary for compliance testbed)
gplazma.oidc.audience-targets = https://wlcg.cern.ch/jwt/v1/any https://dcache.example.com https://dcache.example.com:2880 https://alias.example.com
# ...
</code></pre>
<pre><code># /etc/dcache/multi-mapfile.oidc
op:wlcg               uid:1999 gid:1999,true username:wlcg_oidc
op:atlas              uid:2999 gid:2999,true username:atlas_oidc
op:cms                uid:3999 gid:3999,true username:cms_oidc
</code></pre>
<h2 id="supporting-x509-and-token-access-at-same-time">Supporting X.509 and token access at same time</h2>
<h3 id="dcache-ownership-inheritance">dCache ownership inheritance</h3>
<p>Configuration option <a href="https://github.com/dCache/dcache/blob/8.2.11/skel/share/defaults/pnfsmanager.properties#L136-L149"><code>pnfsmanager.enable.inherit-file-ownership</code></a> can be used to force dCache to assign parent directory owner and group to all new files and subdirectories. This means objects get same owner and groups regardless of client authorization method (access with X.509 VOMS proxy or tokens).</p>
<h3 id="acl-configuration">ACL configuration</h3>
<p>Alternatively to the dCache ownership inheritance it is also possible to rely on ACLs. ACL support must be first enabled in the <code>dcache.conf</code></p>
<pre><code># enable ACL support
pnfsmanager.enable.acl = true
</code></pre>
<p>Default ACLs are also automatically inherited by newly created objects and this functionality is essential for ensuring consistent access for clients authorized with X.509 certificates or tokens.</p>
<h4 id="recursive-acl-updates">Recursive ACL updates</h4>
<p>Currently it is not possible to modify ACL recursively using <code>chimera</code> interface (<a href="https://github.com/dCache/dcache/issues/6844">dCache#6844</a>), but you can use <a href="https://dcache.org/old/manuals/Book-8.2/config-nfs.shtml">NFS mounted dCache</a> and <code>nfs4_setfacl</code>, e.g.
1. enable NFS doors service by updating layout configuration file, e.g.</p>
<pre><code>[doorsDomain/nfs]
nfs.version = 4.1
</code></pre>
<ol>
<li>export NFS filesystem: <code>echo "/ 127.0.0.1(rw,no_root_squash)" &gt;&gt; /etc/exports</code></li>
<li>restart dCache: <code>systemctl restart dcache.target</code></li>
<li>mount dCache: <code>mount -o acl,rw 127.0.0.1:/ /mnt</code></li>
<li>list current ACL configuration:</li>
</ol>
<pre><code>nfs4_getfacl /mnt/atlas/atlaslocalgroupdisk
A:fdg:2000:rx
A:fdg:2001:rwaDdx
A:fdg:2002:rwaDdx
A::OWNER@:rwaDxtTcC
A::GROUP@:rxtc
A::EVERYONE@:rxtc
</code></pre>
<ol>
<li>use listed ACI to recursively update ACL:</li>
</ol>
<pre><code>nfs4_setfacl -R -P -s A:fdg:2000:rx,A:fdg:2001:rwaDdx,A:fdg:2002:rwaDdx,A:fdg:2099:rwaDdx /mnt/atlas/atlaslocalgroupdisk
</code></pre>
<ol>
<li>unmount dCache: <code>umount /mnt</code></li>
</ol>
<h2 id="supported-authorizations">Supported authorizations</h2>
<ol>
<li>Issuer based authorization - access can be granted for any token from given issuer regardless of token content by maping <code>op:isser</code></li>
<li>Group based authorization - when dCache decodes groups from the token (e.g. from <code>wlcg.groups</code> claim in case of WLCG profile) mapping can be applied to <code>oidcgrp:/vo/group_name</code></li>
<li>Scope based authorization - dCache supports access based on storage capabilities defined in several OIDC profiles (e.g. WLCG &amp; SciToken) </li>
</ol>
<p>It is not straightforward to configure dCache properly to use just scope based authorization. WLCG experiments prefers capability security model when it comes to the storage access and that means access with just issuer or group based authorization should be denied. Current dCache releases can't be directly configured to allow access only to one of listed authorization methods and it is necessary to apply special mapping in order to achieve desired behavior.</p>
<p>dCache OIDC plugin configured to use WLCG profile accepts additional configuration parameter <code>authz-id</code> which is used only for tokens that came with explicit AuthZ statements in the scope claim (<code>storage.*:/</code> scope). This behavior enables us to differentiate clients later during identity mapping based on the authorizations available in the token. Clients that did not came with scope based authorization will not be mapped to the dCache <code>uid</code> and <code>gid</code> and/or their namespace root can be set to non-existing directory. Wrong mapping leads to rejected client request.</p>
<p>Following changes needs to be applied to the dCache token configuration described earlier
* gPlazma OIDC provider configuration must be configured with <code>authz-id</code> parameter</p>
<pre><code># /etc/dcache/layouts/your_layout_file.conf
# ...
[centralDomain/gplazma]
# assuming that VO starts in top level directory
gplazma.oidc.provider!wlcg = https://wlcg.cloud.cnaf.infn.it/ -profile=wlcg -prefix=/wlcg -authz-id=username:wlcg_oidc_with_storage_scope
# ...
</code></pre>
<ul>
<li>new multimap mapping for unsupported OIDC authorization methods</li>
</ul>
<pre><code># /etc/dcache/gplazma.conf
...
auth     optional     oidc
map      sufficient   multimap gplazma.multimap.file=/etc/dcache/multi-mapfile.oidc
map      sufficient   multimap gplazma.multimap.file=/etc/dcache/multi-mapfile.oidc-noop
...
session  sufficient   omnisession
#session optional     authzdb
...
</code></pre>
<ul>
<li>content of multimap files ensure access only to the clients that use tokens with explicit <code>storage.*</code> authorization</li>
</ul>
<pre><code># /etc/dcache/multi-mapfile.oidc
username:wlcg_oidc_with_storage_scope     uid:1999 gid:1999,true group:writer
</code></pre>
<pre><code># /etc/dcache/multi-mapfile.oidc-noop
# intentionally wrong/insufficient mapping with missing dCache uid and gid
op:wlcg               username:noop group:noop
</code></pre>
<ul>
<li>assign non-existing root for tokens without storage scopes</li>
</ul>
<pre><code># /etc/dcache/omnisession.conf
group:noop            read-only root:/noop home:/
</code></pre>
<p>In case dCache still rely on old <code>authzdb</code> plugin than namespace root can be set in <code>/etc/grid-security/storage-authzdb</code> to the non-existing directory, e.g.</p>
<pre><code># /etc/grid-security/storage-authzdb
authorize noop read-only 1999 1999 / /noop /
</code></pre>
<h2 id="storage-mapping-and-permissions-configuration">Storage mapping and permissions configuration</h2>
<h3 id="wlcg-compliance-testbed">WLCG compliance testbed</h3>
<p>Storage <a href="https://github.com/indigo-iam/wlcg-jwt-compliance-tests">configuration</a> for compliance tests.</p>
<h3 id="atlas">ATLAS</h3>
<p>With <strong><em>dCache ownership inheritance</em></strong> the configuration is straightforward and it is sufficient to set <a href="https://twiki.cern.ch/twiki/bin/viewauth/AtlasComputing/StorageSetUp#Recommendation">right ownership</a> only to the top level directories in the root of ATLAS namespace. Most common configuration can be very simple</p>
<ul>
<li><code>/atlas-root</code> - read only for /atlas group</li>
<li><code>/atlas-root/atlasscratchdisk</code> - inheritable read for <code>FQAN:/atlas</code> and write for <code>FQAN:/atlas</code></li>
<li><code>/atlas-root/atlasdatadisk</code> - inheritable read for <code>FQAN:/atlas</code> and write for <code>FQAN:/atlas/Role=production</code></li>
<li><code>/atlas-root/atlaslocalgroupdisk</code> - inheritable read for <code>FQAN:/atlas</code> and write for <code>FQAN:/atlas/country_code</code></li>
</ul>
<p>The configuration can be slightly more complex when dCache rely just on <strong><em>ACLs</em></strong>, because then it is necessary to set directory permissions that will be inherited by new directories and files. For example following X.509 identity mapping <code>FQAN:/atlas</code> gid 2000, <code>FQAN:/atlas/Role=production</code> gid 2001, <code>FQAN:/atlas/cz</code> gid 2002 could be used to achieve behavior expected from ATLAS storage</p>
<pre><code>$ chimera ls /
dr-xr-x---   19 2000 2000        512 May 10 00:00 atlas-root
$ chimera ls /atlas-root
drwxr-xr-x   10 2001 2001        512 Jun 01  2020 atlasdatadisk
drwxr-xr-x    5 2001 2001        512 Jan 18  2020 atlaslocalgroupdisk
drwxr-xr-x   60 2001 2001        512 Aug 19  2021 atlasscratchdisk
$ chimera getfacl /atlas-root/atlasscratchdisk
GROUP:2000:+lfsxDd:fdg
$ chimera getfacl /atlas-root/atlasdatadisk
GROUP:2001:+lfsxDd:fdg
GROUP:2000:+lx:fdg
$ chimera getfacl /atlas-root/atlaslocalgroupdisk
GROUP:2002:+lfsxDd:fdg
GROUP:2001:+lfsxDd:fdg
GROUP:2000:+lx:fdg
</code></pre>
<p>Both configurations works well with clients accessing storage either with X.509 or WLCG tokens and scope based authorization.</p>
<h4 id="configuration">configuration</h4>
<pre><code># /etc/dcache/layouts/your_layout_file.conf
# ...
[centralDomain/gplazma]
# assuming that VO starts in top level directory /atlas
gplazma.oidc.provider!atlas = https://atlas-auth.web.cern.ch/ -profile=wlcg -prefix=/atlas -authz-id=username:atlas_oidc_with_storage_scope
# you can specify multiple audiences, e.g. https://wlcg.cern.ch/jwt/v1/any is necessary
# for compliance testbed and also CMS, but for ATLAS it is currently sufficient to use
# &quot;headnode&quot; (doors) hostname(s) / hostnames defined in the ATLAS Rucio protocol configuration
# that can be obtained with `rucio-admin rse info PRAGUELCG2_DATADISK` or from ATLAS CRIC web interface
gplazma.oidc.audience-targets = davs.example.com xroot.example.com
# ...
</code></pre>
<pre><code># /etc/dcache/gplazma.conf
...
auth     optional     oidc
map      sufficient   multimap gplazma.multimap.file=/etc/dcache/multi-mapfile.oidc
map      sufficient   multimap gplazma.multimap.file=/etc/dcache/multi-mapfile.oidc-noop
...
# this depends if your dCache still rely on storage-authzdb or omnisession as described in earlier sections
session  sufficient   omnisession
#session optional     authzdb
...
</code></pre>
<pre><code># /etc/dcache/multi-mapfile.oidc
# This mapping applies to the tokens that came with explicit AuthZ
# statements in the scope claim (storage.*:/ scopes in case of
# WLCG/SciTokens).
username:atlas_oidc_with_storage_scope     uid:2000 gid:2001,true
# sites that used DPM to dCache migration tools should add group:writer
#username:atlas_oidc_with_storage_scope    uid:2000 gid:2001,true group:writer
</code></pre>
<pre><code># /etc/dcache/multi-mapfile.oidc-noop
# Tokens with just group (oidcgrp:) or issuer (op:) based authorization
# are not mapped in the multi-mapfile.oidc, because dCache doesn't add
# principals from authz-id parameter defined with gplazma.oidc.provider
#
# If we would like to support just capability based access with WLCG/SciToken
# profile (tokens with storage.*:/ scopes) we intentionally use bad (sufficient)
# mapping configured here to deny access. Although missing dCache uid and gid
# mapping is sufficient to reject clients special group &quot;noop&quot; is also mapped
# to non-existing directory in the omnisession or storage-authzdb configuration file.
op:atlas              username:noop group:noop
</code></pre>
<pre><code># /etc/dcache/omnisession.conf
...
# deny access by mapping &quot;noop&quot; group to non-existing root directiory
# this is here just for safety, because client should be already kicked
# out while its identity is not even mapped to any dCache uid and gid
group:noop            read-only root:/noop home:/
...
</code></pre>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.aecac24b.min.js"></script>
      
    
  </body>
</html>